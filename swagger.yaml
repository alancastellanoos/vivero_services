openapi: 3.0.0
info:
  title: API de Vivero (Node.js/Sequelize)
  version: 1.0.0
  description: Documentación de la API para la gestión de usuarios, plantas en adopción, solicitudes y mensajería.
servers:
  - url: /api
    description: Servidor Local

components:
  securitySchemes:
    BearerAuth:
      type: http
      scheme: bearer
      bearerFormat: JWT
  
  schemas:
    # --- ESQUEMA DE USUARIO (MANTENIDO) ---
    User:
      # ... (Estructura de Usuario mantenida) ...
      type: object
      properties:
        id:
          type: integer
          readOnly: true
          example: 1
        name:
          type: string
          example: Juan Perez
        email:
          type: string
          example: juan@mail.com
        password:
          type: string
          writeOnly: true
          description: Contrasena sin hashear (solo para POST/PUT)
          example: miContrasenaSecreta
      required: 
        - name
        - email
        - password
    
    # --- ESQUEMA DE TAG (NUEVO) ---
    Tag:
      type: object
      properties:
        id:
          type: integer
          readOnly: true
          example: 1
        name:
          type: string
          example: Suculenta

    # --- ESQUEMA DE CUIDADOS (NUEVO) ---
    PlantCare:
      type: object
      properties:
        light:
          type: string
          example: Indirecta Brillante
        watering:
          type: string
          example: Cada 7-10 días
        humidity:
          type: string
          example: Baja
        temperature:
          type: string
          example: 18-25°C
      required:
        - light
        - watering
        - humidity
        - temperature
        
    # --- ESQUEMA DE PLANTA (ACTUALIZADO para reflejar el backend) ---
    Plant:
      type: object
      properties:
        id:
          type: integer
          readOnly: true
          example: 5
        name:
          type: string
          example: Cactus Silla de Suegra
        description:
          type: string
          example: Lo dejo porque creció mucho. Necesita mucho sol.
        status:
          type: string
          enum: [AVAILABLE, PENDING_AGREEMENT, ADOPTED]
          example: AVAILABLE
        userId:
          type: integer
          readOnly: true
          description: ID del usuario Donante.
        isCatalog:
          type: boolean
          description: Indica si es solo una planta informativa (Catálogo).
          example: false
        location:
          type: string
          example: Guadalajara
        tags:
          type: array
          items:
            $ref: '#/components/schemas/Tag'
          description: Etiquetas asociadas.
        PlantCare:
          $ref: '#/components/schemas/PlantCare'
          description: Información de cuidados si aplica.
      required: 
        - name
        - description
    
    # --- ESQUEMA DE SOLICITUD DE ADOPCIÓN (NUEVO) ---
    AdoptionRequest:
      type: object
      properties:
        id:
          type: integer
          readOnly: true
          example: 10
        plantId:
          type: integer
          example: 5
        requesterId:
          type: integer
          readOnly: true
          example: 2
        message:
          type: string
          nullable: true
          example: Me gustaría mucho adoptarla, cuido bien las plantas.
        status:
          type: string
          enum: [PENDING, ACCEPTED, REJECTED]
          example: PENDING
      required:
        - plantId

    # --- ESQUEMA DE MENSAJE (NUEVO) ---
    Message:
      type: object
      properties:
        id:
          type: integer
          readOnly: true
          example: 101
        requestId:
          type: integer
          readOnly: true
          example: 10
        senderId:
          type: integer
          readOnly: true
          example: 1
        content:
          type: string
          example: ¿Podríamos vernos el sábado por la mañana?
        isAgreementFinalized:
          type: boolean
          example: false
      required:
        - content

paths:
  # --- RUTAS DE AUTENTICACION Y USUARIOS (MANTENIDAS) ---
  /auth/login:
    # ... (Mantenido) ...
  /users:
    # ... (Mantenido) ...
  /users/{id}:
    # ... (Mantenido) ...
    
  # --- RUTAS DE PLANTAS EN ADOPCION Y CATÁLOGO ---

  /plants:
    get:
      tags:
        - Plantas
      summary: "[READ ALL] Obtiene lista de plantas disponibles, catálogo, o ambas."
      parameters:
        - in: query
          name: searchTerm
          schema:
            type: string
          description: Texto para buscar en el nombre de la planta.
        - in: query
          name: tagId
          schema:
            type: integer
          description: Filtrar por ID de etiqueta.
        - in: query
          name: isCatalog
          schema:
            type: boolean
          description: 'Si es true, busca en el catálogo de cuidados. Si es false/ausente, busca en adopción.'
        - in: query
          name: status
          schema:
            type: string
            enum: [AVAILABLE, PENDING_AGREEMENT, ADOPTED]
          description: Filtrar por estado de adopción.
      responses:
        '200':
          description: Lista de plantas obtenida.

    post:
      tags:
        - Plantas
      summary: "[CREATE] Publica una planta en adopción o catálogo (Protegida)."
      security:
        - BearerAuth: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              properties:
                plantData:
                  $ref: '#/components/schemas/Plant'
                tagIds:
                  type: array
                  items:
                    type: integer
                  description: Array de IDs de Tags.
                careData:
                  $ref: '#/components/schemas/PlantCare'
                  description: Información de cuidados (si es para catálogo).
      responses:
        '201':
          description: Planta creada exitosamente.
  
  /plants/my-plants:
    get:
      tags:
        - Plantas
      summary: "[READ ALL] Obtiene las plantas publicadas por el usuario logueado (Mi Perfil)."
      security:
        - BearerAuth: []
      responses:
        '200':
          description: Lista de plantas del usuario obtenida.

  /plants/{id}:
    parameters:
      - in: path
        name: id
        schema:
          type: integer
        required: true
        description: ID de la planta.
        
    get:
      # ... (Mantenido) ...
    
    put:
      tags:
        - Plantas
      summary: "[UPDATE] Actualiza una planta por ID (Protegida - Solo Donante)."
      security:
        - BearerAuth: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              properties:
                plantData:
                  $ref: '#/components/schemas/Plant'
                tagIds:
                  type: array
                  items:
                    type: integer
                  description: Nuevos IDs de Tags a asociar.
                careData:
                  $ref: '#/components/schemas/PlantCare'
                  description: Información de cuidados si se actualiza.
      responses:
        '200':
          description: Planta actualizada.
        '403':
          description: No tienes permiso para editarla.

    delete:
      # ... (Mantenido) ...


  # --- NUEVAS RUTAS DE SOLICITUDES DE ADOPCIÓN ---
  
  /requests:
    post:
      tags:
        - Solicitudes de Adopcion
      summary: "[CREATE] Crea una solicitud para adoptar una planta (Protegida)."
      security:
        - BearerAuth: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/AdoptionRequest'
      responses:
        '201':
          description: Solicitud creada exitosamente.
        '400':
          description: La planta no está disponible o ya solicitaste.

  /requests/incoming:
    get:
      tags:
        - Solicitudes de Adopcion
      summary: "[READ ALL] Obtiene las solicitudes recibidas por el usuario (Donante)."
      security:
        - BearerAuth: []
      responses:
        '200':
          description: Lista de solicitudes entrantes.

  /requests/{id}/accept:
    put:
      tags:
        - Solicitudes de Adopcion
      summary: "[UPDATE] Acepta una solicitud (habilita el chat). Solo Donante."
      security:
        - BearerAuth: []
      parameters:
        - in: path
          name: id
          schema:
            type: integer
          required: true
          description: ID de la Solicitud.
      responses:
        '200':
          description: Solicitud aceptada y chat habilitado.

  /requests/{id}/reject:
    put:
      tags:
        - Solicitudes de Adopcion
      summary: "[UPDATE] Rechaza una solicitud. Solo Donante."
      security:
        - BearerAuth: []
      parameters:
        - in: path
          name: id
          schema:
            type: integer
          required: true
          description: ID de la Solicitud.
      responses:
        '200':
          description: Solicitud rechazada.

  # --- NUEVAS RUTAS DE MENSAJERÍA (CHAT) ---
  
  /messages/{requestId}:
    parameters:
      - in: path
        name: requestId
        schema:
          type: integer
        required: true
        description: ID de la Solicitud Aceptada (actúa como ID del Chat).

    get:
      tags:
        - Mensajería (Chat)
      summary: "[READ ALL] Obtiene el historial de mensajes del acuerdo (Protegida)."
      security:
        - BearerAuth: []
      responses:
        '200':
          description: Historial de mensajes.

    post:
      tags:
        - Mensajería (Chat)
      summary: "[CREATE] Envía un mensaje al chat de acuerdo (Protegida)."
      security:
        - BearerAuth: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/Message'
      responses:
        '201':
          description: Mensaje enviado.

  /messages/{requestId}/finalize:
    put:
      tags:
        - Mensajería (Chat)
      summary: "[UPDATE] Marca el acuerdo como cerrado/planta entregada (Protegida)."
      security:
        - BearerAuth: []
      parameters:
        - in: path
          name: requestId
          schema:
            type: integer
          required: true
          description: ID de la Solicitud Aceptada (ID del Chat).
      responses:
        '200':
          description: Acuerdo finalizado y planta marcada como ADOPTED.